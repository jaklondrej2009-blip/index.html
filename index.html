<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VR Střelnice — jednoduchá ukázka (A-Frame)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- physics: cannon.js system for A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
  <style>body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#111;color:#ddd}#info{position:fixed;left:10px;top:10px;z-index:10;background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;font-size:14px}</style>
</head>
<body>
  <div id="info">
    Ovládání: v VR použij ovladače (trigger = střelba, grip = výběr/uchopení). Na desktopu myš/Klik = střelit. 1-3 = přepnout zbraň, R = obnovit cíle.
  </div>

  <!-- A-Frame scéna -->
  <a-scene physics="gravity: -9.8" renderer="antialias: true" background="color: #88c0ff">

    <!-- kamera + desktop support -->
    <a-entity id="cameraRig" position="0 1.6 3">
      <a-entity camera look-controls wasd-controls></a-entity>
    </a-entity>

    <!-- ground -->
    <a-entity geometry="primitive: plane; width: 40; height: 40" rotation="-90 0 0" material="color: #2b6b2b; metalness:0.1; roughness:1" static-body></a-entity>

    <!-- back wall and range stand -->
    <a-box position="0 2 -12" depth="0.5" height="6" width="40" material="color:#6b4f2b"></a-box>

    <!-- decorative lights and props -->
    <a-entity id="props">
      <!-- lanterns -->
      <a-entity light="type: point; intensity:1.2; distance:12; color:#ffd27f" position="-6 3 -6"></a-entity>
      <a-entity light="type: point; intensity:1.0; distance:10; color:#ffd27f" position="6 3 -6"></a-entity>

      <!-- banner -->
      <a-plane position="0 4 -11.7" width="10" height="1.5" color="#222" material="shader: flat">
        <a-text value="STŘELNICE" align="center" color="#ffd" position="0 0 0.01" width="8"></a-text>
      </a-plane>

      <!-- wooden stalls and barrels -->
      <a-box position="-10 0.5 -6" depth="2" height="1" width="2" material="color:#8b5a2b" static-body></a-box>
      <a-cylinder position="10 0.5 -6" radius="0.8" height="1" rotation="0 0 0" material="color:#6a3f1f" static-body></a-cylinder>

      <!-- small trees (decor) -->
      <a-cone position="-12 1 -10" radius-bottom="0.9" height="2" color="#156515"></a-cone>
      <a-cone position="12 1 -10" radius-bottom="0.9" height="2" color="#156515"></a-cone>
    </a-entity>

    <!-- targets area -->
    <a-entity id="targets">
      <!-- create 9 targets in a grid -->
      <script id="targets-template" type="text/plain"></script>
    </a-entity>

    <!-- physics-enabled crates that can be knocked over -->
    <a-box position="-4 0.5 -8" width="1" height="1" depth="1" color="#a67c52" dynamic-body></a-box>
    <a-box position="4 0.5 -8" width="1" height="1" depth="1" color="#a67c52" dynamic-body></a-box>

    <!-- controllers (VR hands) -->
    <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc" laser-controls raycaster="objects: .clickable"></a-entity>
    <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ccccff" laser-controls raycaster="objects: .clickable"></a-entity>

    <!-- simple guns attached to right hand (switched via keys) -->
    <a-entity id="gunHolder" position="0 0 0">
      <!-- pistol -->
      <a-entity id="gun-pistol" class="gun" visible="true" position="0 -0.05 -0.25" rotation="0 0 0">
        <a-box width="0.12" height="0.06" depth="0.28" color="#222"></a-box>
        <a-box position="0 0.02 0.08" width="0.06" height="0.03" depth="0.16" color="#555"></a-box>
      </a-entity>
      <!-- rifle -->
      <a-entity id="gun-rifle" class="gun" visible="false" position="0 -0.1 -0.35">
        <a-box width="0.08" height="0.06" depth="0.9" color="#111"></a-box>
        <a-cylinder position="0 -0.02 0.35" radius="0.02" height="0.5" rotation="90 0 0" color="#333"></a-cylinder>
      </a-entity>
      <!-- shotgun -->
      <a-entity id="gun-shotgun" class="gun" visible="false" position="0 -0.08 -0.28">
        <a-box width="0.12" height="0.08" depth="0.5" color="#1a1a1a"></a-box>
      </a-entity>
    </a-entity>

    <!-- small cannon on left hand -->
    <a-entity id="left-cannon" position="0 1.6 3">
      <!-- will be linked to left controller by script -->
    </a-entity>

    <!-- floor markers -->
    <a-ring position="0 0.01 0" rotation="-90 0 0" radius-inner="0.2" radius-outer="0.5" material="color:#fff; side:double"></a-ring>

    <!-- sky for nicer look -->
    <a-sky color="#87ceeb"></a-sky>

    <!-- audio for shoot -->
    <a-assets>
      <audio id="shot" src="https://cdn.jsdelivr.net/gh/kevingimbel/sounds@master/shot.wav"></audio>
    </a-assets>

  </a-scene>

  <script>
    // Insert targets programmatically
    (function(){
      const targetsEl = document.getElementById('targets');
      const rows = 3, cols = 3;
      const startX = -4, startY = 2, startZ = -10;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const x = startX + c*4;
          const y = startY - r*1.2;
          const z = startZ;
          const target = document.createElement('a-cylinder');
          target.setAttribute('position', `${x} ${y} ${z}`);
          target.setAttribute('radius', '0.6');
          target.setAttribute('height', '0.1');
          target.setAttribute('rotation', '90 0 0');
          target.setAttribute('class', 'clickable');
          target.setAttribute('color', '#e74c3c');
          target.setAttribute('dynamic-body', 'mass: 1');
          targetsEl.appendChild(target);
        }
      }
    })();

    // Helper: spawn bullet with physics
    function spawnBullet(originEl, directionVec, speed, radius=0.04, mass=0.2){
      const scene = document.querySelector('a-scene');
      const bullet = document.createElement('a-sphere');
      const pos = originEl.object3D.getWorldPosition(new THREE.Vector3());
      bullet.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
      bullet.setAttribute('radius', radius);
      bullet.setAttribute('dynamic-body', `mass: ${mass}`);
      bullet.setAttribute('geometry', `primitive: sphere; radius: ${radius}`);
      bullet.setAttribute('material', 'color: #222');

      // when added to scene, push
      scene.appendChild(bullet);
      // Wait a tick for physics body to initialize
      setTimeout(()=>{
        if(!bullet.body){
          // if physics body missing, set velocity via three.js fallback
          if(bullet.object3D && bullet.object3D.position){
            bullet.object3D.position.set(pos.x, pos.y, pos.z);
            if(bullet.body) bullet.body.velocity.set(directionVec.x*speed, directionVec.y*speed, directionVec.z*speed);
          }
        } else {
          bullet.body.velocity.set(directionVec.x*speed, directionVec.y*speed, directionVec.z*speed);
        }

        // remove after 8s
        setTimeout(()=>{ if(bullet.parentNode) bullet.parentNode.removeChild(bullet); }, 8000);
      }, 50);

      // add simple collision callback
      bullet.addEventListener('collide', function(e){
        const other = e.detail.body.el;
        if(other && other.classList && other.classList.contains('clickable')){
          // hit a target: change color and apply extra impulse
          other.setAttribute('color', '#ffd700');
          // small push
          try{ other.body.applyImpulse(new CANNON.Vec3(directionVec.x*0.5, directionVec.y*0.2, directionVec.z*0.5), new CANNON.Vec3().copy(other.body.position)); } catch(e){}
        }
      });
    }

    // Attach gun models to right controller and handle shooting
    (function(){
      const right = document.getElementById('rightHand');
      const gunHolder = document.getElementById('gunHolder');
      // parent gunHolder to controller so it moves with hand
      right.appendChild(gunHolder);

      // also attach small cannon to left controller
      const left = document.getElementById('leftHand');
      const leftCannon = document.getElementById('left-cannon');
      const cannonModel = document.createElement('a-cylinder');
      cannonModel.setAttribute('height', '0.3');
      cannonModel.setAttribute('radius', '0.08');
      cannonModel.setAttribute('rotation', '0 90 0');
      cannonModel.setAttribute('position', '0 -0.05 -0.25');
      cannonModel.setAttribute('color', '#444');
      left.appendChild(cannonModel);

      // weapon states
      const guns = ['gun-pistol','gun-rifle','gun-shotgun'];
      let current = 0;
      function showGun(index){
        guns.forEach((id,i)=>{ document.getElementById(id).setAttribute('visible', i===index); });
      }

      // shoot handler
      function shootFromController(controllerEl){
        // get forward direction
        const worldPos = controllerEl.object3D.getWorldPosition(new THREE.Vector3());
        const forward = new THREE.Vector3(0,0,-1);
        controllerEl.object3D.getWorldDirection(forward);
        const dir = forward.normalize();
        // adapt speed by weapon
        let speed = 20;
        if(guns[current]==='gun-pistol') speed = 28;
        if(guns[current]==='gun-rifle') speed = 45;
        if(guns[current]==='gun-shotgun') speed = 18;

        spawnBullet(controllerEl, dir, speed, guns[current]==='gun-shotgun'?0.08:0.04, 0.3);
        // play audio if exists
        const audio = document.querySelector('#shot');
        if(audio){ const a = new Audio(audio.getAttribute('src')); a.volume = 0.3; a.play().catch(()=>{}); }
      }

      // cannon shoot from left hand (bigger projectile)
      function shootCannonFrom(controllerEl){
        const forward = new THREE.Vector3();
        controllerEl.object3D.getWorldDirection(forward);
        const dir = forward.normalize();
        spawnBullet(controllerEl, dir, 12, 0.18, 2);
      }

      // listen to trigger events for VR controllers
      right.addEventListener('triggerdown', ()=> shootFromController(right));
      left.addEventListener('triggerdown', ()=> shootCannonFrom(left));

      // desktop: click to shoot from camera
      document.addEventListener('click', (e)=>{
        const cam = document.querySelector('[camera]');
        shootFromController(cam);
      });

      // keyboard: switch guns and respawn targets
      document.addEventListener('keydown', (e)=>{
        if(e.key==='1'){ current=0; showGun(current); }
        if(e.key==='2'){ current=1; showGun(current); }
        if(e.key==='3'){ current=2; showGun(current); }
        if(e.key==='r' || e.key==='R'){ respawnTargets(); }
      });

      showGun(current);
    })();

    // respawn targets function
    function respawnTargets(){
      const targets = document.querySelectorAll('#targets a-cylinder');
      let i=0;
      targets.forEach((t)=>{
        const x = -4 + (i%3)*4;
        const y = 2 - Math.floor(i/3)*1.2;
        t.setAttribute('position', `${x} ${y} -10`);
        t.setAttribute('color', '#e74c3c');
        // reset physics
        if(t.body){
          try{ t.body.position.set(x,y,-10); t.body.velocity.set(0,0,0); t.body.angularVelocity.set(0,0,0); }catch(e){}
        }
        i++;
      });
    }

  </script>
</body>
</html>
